# vim: set ft=sh:
# shellcheck disable=SC3030,SC3054,SC3010
log() {
  printf "\033[0;33m%s\033[0m\n" "${1}"
}

BREW_PACKAGES=(
boost
cmake
coreutils
direnv
dust
editorconfig
exa
exiftool
ffmpeg
findutils
fzf
git
git-delta
gnu-tar
gsed
imagemagick
jhead
jq
jump
node
oath-toolkit
openconnect
openssl
pstree
python
readline
ripgrep
ruby-build
rustup-init
selene
shellcheck
sqlite
stylua
syncthing
tig
volta
watch
wireguard-tools
yarn
ydiff
yt-dlp
zsh
)

BREW_CASKS=(
android-platform-tools
aws-vault
disk-inventory-x
gpg-suite
hammerspoon
iterm2
itsycal
keepassxc
macvim
namechanger
qlimagesize
qlmarkdown
quicklook-json
shottr
the-unarchiver
typora
vlc
)

NODE_PACKAGES=(
eslint
jsonlint
pnpm
prettier
)

RUBY_GEMS=(
pry-byebug
wirb
)

log ">>> Updating zsh_config"
[ -e ~/dev/config/zsh_config ] && cd  ~/dev/config/zsh_config && git pull --rebase --autostash

log ">>> Updating vim_config"
[ -e ~/dev/config/zsh_config ] && cd  ~/dev/config/vim_config && git pull --rebase --autostash

log ">>> Installing missing homebrew packages"
brew tap universal-ctags/universal-ctags

# Check installed packages
INSTALLED=$(brew list --formula -1 | tr '\n' ' ')
for p in "${BREW_PACKAGES[@]}"; do
 [[ "${INSTALLED}" != *$p* ]] && brew install "${p}"
done


# Error: It seems there is already a Binary at '/usr/local/bin/gview'.
# for bin in mvim mvimdiff mview mvimex gvim gvimdiff gview gvimex view; do
#   rm -rf /usr/local/bin/$bin
# done

# Check install casks
INSTALLED=$(brew list --casks -1 | tr '\n' ' ')
for p in "${BREW_CASKS[@]}"; do
 [[ ${INSTALLED} != *$p* ]] && brew install --cask "${p}"
done

if ! brew ls --versions universal-ctags; then
  brew install --fetch-HEAD --HEAD universal-ctags
fi

brew upgrade

log ">>> Updating rubygems"
gem update --system

log ">>> Installing important gems"
gem install "${RUBY_GEMS[@]}"

log ">>> Installing important JS tools"
log ">>> npm: $(which npm)"
log ">>> pnpm: $(which pnpm)"
pnpm add -g "${NODE_PACKAGES[@]}" || true

log ">>> Setting permission for quicklook plugins"
/usr/bin/xattr -r ~/Library/QuickLook > /dev/null
/usr/bin/xattr -d -r com.apple.quarantine ~/Library/QuickLook > /dev/null

# if [ -d /Applications/Microsoft\ Teams.app ]; then 
#   if 2>/dev/null 1>&2 codesign --verify "/Applications/Microsoft Teams.app"; then 
#     log ">>> Removing code signage from MS Teams for virtual cams to work"
#     sudo codesign --remove-signature "/Applications/Microsoft Teams.app"
#     sudo codesign --remove-signature "/Applications/Microsoft Teams.app/Contents/Frameworks/Microsoft Teams Helper.app"
#     sudo codesign --remove-signature "/Applications/Microsoft Teams.app/Contents/Frameworks/Microsoft Teams Helper (GPU).app"
#     sudo codesign --remove-signature "/Applications/Microsoft Teams.app/Contents/Frameworks/Microsoft Teams Helper (Renderer).app"
#     sudo codesign --remove-signature "/Applications/Microsoft Teams.app/Contents/Frameworks/Microsoft Teams Helper (Plugin).app"
#   fi
# fi
#
log ">>> Special Apps"
if ! hash ruplacer 2>/dev/null; then
  log ">>> Installing ruplacer from github releases"
  curl -L -q -s -o "$HOMEBREW_PREFIX/bin/ruplacer" "$(curl -s https://api.github.com/repos/your-tools/ruplacer/releases/latest | jq -r ".assets[] | select(.name | test(\"osx\")) | .browser_download_url")" && chmod +x "$HOMEBREW_PREFIX/bin/ruplacer"
fi

if ! hash kdiff3 2>/dev/null; then
  log ">>> Installing kdiff3 from source (This will take some time)"
  brew tap kde-mac/kde https://invent.kde.org/packaging/homebrew-kde.git --force-auto-update
  brew install kde-mac/kde/kdiff3 --HEAD
fi
